
core/freepbx.py:

import time
import re
import logging
from typing import Dict, List, Tuple, Optional

import requests

log = logging.getLogger(__name__)


class AlreadyExists(Exception):
    """Raised when an entity already exists on FreePBX side."""
    pass


class FreePBX:
    def __init__(self, base_url: str, client_id: str, client_secret: str, verify: bool = True):
        self.base_url = base_url.rstrip("/")
        self.client_id = client_id
        self.client_secret = client_secret
        self.verify = verify
        self.token: Optional[str] = None
        self.token_exp: float = 0.0

    # ----- URLs -----
    @property
    def token_url(self) -> str:
        return f"{self.base_url}/admin/api/api/token"

    @property
    def gql_url(self) -> str:
        return f"{self.base_url}/admin/api/api/gql"

    # ----- Auth / GQL -----
    def ensure_token(self) -> None:
        now = time.time()
        if self.token and now < self.token_exp - 30:
            return
        data = {
            "grant_type": "client_credentials",
            "client_id": self.client_id,
            "client_secret": self.client_secret,
            "scope": "gql gql:core",
        }
        r = requests.post(self.token_url, data=data, timeout=25, verify=self.verify)
        r.raise_for_status()
        j = r.json()
        self.token = j["access_token"]
        self.token_exp = now + int(j.get("expires_in", 3600))

    def gql(self, query: str, variables: Optional[dict] = None) -> dict:
        self.ensure_token()
        h = {"Authorization": f"Bearer {self.token}"}
        r = requests.post(
            self.gql_url,
            json={"query": query, "variables": variables or {}},
            timeout=35,
            verify=self.verify,
            headers=h,
        )
        r.raise_for_status()
        js = r.json()
        if "errors" in js:
            raise RuntimeError(js["errors"])
        return js["data"]

    # ----- Extensions: read -----
    def fetch_all_extensions(self) -> List[Tuple[str, str]]:
        q_full = """
        query {
          fetchAllExtensions {
            extension {
              extensionId
              tech
              pjsip { secret }
              user { password extPassword }
            }
          }
        }
        """
        q_fallback = """
        query {
          fetchAllExtensions {
            extension {
              extensionId
              user { password extPassword }
            }
          }
        }
        """
        try:
            data = self.gql(q_full)
            exts = data["fetchAllExtensions"]["extension"]
        except Exception:
            data = self.gql(q_fallback)
            exts = data["fetchAllExtensions"]["extension"]

        out: List[Tuple[str, str]] = []
        for e in exts:
            ext = str(e["extensionId"])
            u = e.get("user") or {}
            pw = u.get("extPassword") or (e.get("pjsip", {}) or {}).get("secret") or u.get("password") or ""
            out.append((ext, pw))
        out.sort(key=lambda x: int(re.sub(r"\D", "", x[0]) or 0))
        return out

    def fetch_ext_index(self):
        queries = [
            """
            query {
              fetchAllExtensions {
                extension {
                  extensionId
                  user { extPassword name displayname }
                }
              }
            }
            """,
            """
            query {
              fetchAllExtensions {
                extension {
                  extensionId
                  user { password }
                }
              }
            }
            """,
            """
            query {
              fetchAllExtensions {
                extension { extensionId }
              }
            }
            """,
        ]

        def pick_name(e: dict) -> str:
            u = e.get("user") or {}
            for k in ("name", "displayname", "username"):
                v = u.get(k)
                if isinstance(v, str) and v.strip():
                    return v.strip()
            return ""

        for q in queries:
            try:
                data = self.gql(q)
                exts = data["fetchAllExtensions"]["extension"]
                by_ext: Dict[str, Dict[str, str]] = {}
                name_set = set()
                for e in exts:
                    ext = str(e["extensionId"])
                    name = pick_name(e)
                    by_ext[ext] = {"name": name, "pw": ""}  # pw –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –∑–¥–µ—Å—å
                    if name:
                        name_set.add(name.lower())
                return by_ext, name_set, bool(name_set)
            except Exception:
                continue

        return {}, set(), False

    # ----- Extensions: write -----
    def delete_extension(self, extension: str) -> None:
        ext_str = str(extension)
        variants = [
            ("ID",     "id",           "input"),
            ("String", "id",           "input"),
            ("ID",     "extensionId",  "input"),
            ("String", "extensionId",  "input"),
            ("ID",     "extension",    "input"),
            ("String", "extension",    "input"),
            ("ID",     "extId",        "input"),
            ("String", "extId",        "input"),
            ("ID",     "id",           "direct"),
            ("String", "id",           "direct"),
            ("ID",     "extensionId",  "direct"),
            ("String", "extensionId",  "direct"),
            ("ID",     "extension",    "direct"),
            ("String", "extension",    "direct"),
            ("ID",     "extId",        "direct"),
            ("String", "extId",        "direct"),
        ]
        last_err = None
        for typ, field, mode in variants:
            if mode == "input":
                m = f"""
                mutation($ext: {typ}!) {{
                  deleteExtension(input: {{ {field}: $ext }}) {{ status message }}
                }}
                """
            else:
                m = f"""
                mutation($ext: {typ}!) {{
                  deleteExtension({field}: $ext) {{ status message }}
                }}
                """
            try:
                self.gql(m, {"ext": ext_str})
                return
            except Exception as e:
                last_err = e
                continue
        raise RuntimeError(f"deleteExtension failed (all variants): {last_err}")

    def create_one(self, ext: int, name: Optional[str] = None) -> None:
        m = """
        mutation($start: ID!, $name: String!, $email: String!) {
          createRangeofExtension(input:{
            startExtension: $start,
            numberOfExtensions: 1,
            tech: "pjsip",
            name: $name,
            email: $email,
            vmEnable: true,
            umEnable: true
          }) {
            status
            message
          }
        }
        """
        nm = str(name).strip() if (name and str(name).strip()) else str(ext)
        vars = {
            "start": str(ext),
            "name": nm,
            "email": f"{ext}@local",
        }
        self.gql(m, vars)

    def set_ext_password(self, extension: str, secret: str) -> None:
        m_id = """
        mutation($extId: ID!, $name: String!, $pwd: String!) {
          updateExtension(input: {
            extensionId: $extId,
            name: $name,
            extPassword: $pwd
          }) { status message }
        }
        """
        m_str = """
        mutation($extId: String!, $name: String!, $pwd: String!) {
          updateExtension(input: {
            extensionId: $extId,
            name: $name,
            extPassword: $pwd
          }) { status message }
        }
        """
        vars_id = {"extId": str(extension), "name": str(extension), "pwd": secret}
        try:
            self.gql(m_id, vars_id)
        except Exception as e1:
            vars_str = {"extId": str(extension), "name": str(extension), "pwd": secret}
            try:
                self.gql(m_str, vars_str)
            except Exception as e2:
                raise RuntimeError(f"updateExtension failed: ID! -> {e1}; String! -> {e2}")

    # ----- Apply Config -----
    def apply_config(self) -> dict:
        gql_mutation = """
        mutation {
            doreload(input: {}) {
              status
              message
              transaction_id
            }
        }
        """
        try:
            data = self.gql(gql_mutation)
            return data.get("doreload") or {"status": True, "message": "doreload ok"}
        except Exception as e1:
            url = f"{self.base_url}/admin/ajax.php"
            try:
                r = requests.get(url, params={"command": "reload"}, timeout=25, verify=self.verify)
                r.raise_for_status()
                try:
                    return {"status": True, "message": str(r.json())[:400]}
                except ValueError:
                    return {"status": True, "message": r.text[:400]}
            except Exception as e2:
                raise RuntimeError(f"Apply Config failed: GraphQL doreload -> {e1}; ajax reload -> {e2}")

    # ----- Inbound Routes -----
    def create_inbound_route(self, did: str, description: str, ext: str) -> None:
        did = str(did).strip()
        description = str(description).strip()
        ext = str(ext).strip()

        candidates = [
            f"from-did-direct,{ext},1",
            f"ext-local,{ext},1",
        ]

        def _post_gql(mutation: str, variables: dict):
            self.ensure_token()
            h = {"Authorization": f"Bearer {self.token}"}
            resp = requests.post(
                self.gql_url,
                json={"query": mutation, "variables": variables},
                timeout=35,
                verify=self.verify,
                headers=h,
            )
            text = resp.text
            try:
                data = resp.json()
            except Exception:
                data = None

            if not resp.ok:
                lower = (text or "").lower()
                if any(k in lower for k in ("already", "exist", "duplicate", "unique")):
                    raise AlreadyExists(text[:300])
                resp.raise_for_status()

            if isinstance(data, dict) and "errors" in data:
                joined = " | ".join(str(e.get("message", "")) for e in data["errors"])
                lower = joined.lower()
                if any(k in lower for k in ("already", "exist", "duplicate", "unique")):
                    raise AlreadyExists(joined[:300])
                raise RuntimeError(joined or "GraphQL error")

            return data

        mutation = """
        mutation($did:String!, $desc:String!, $dest:String!) {
            addInboundRoute(input:{
                extension: $did,
                description: $desc,
                destination: $dest
            }) {
                status
                message
                inboundRoute { id }
            }
        }"""

        last_err: Optional[Exception] = None
        for dest in candidates:
            try:
                _post_gql(mutation, {"did": did, "desc": description, "dest": dest})
                return
            except AlreadyExists:
                raise
            except Exception as e:
                last_err = e
                continue

        msg = str(last_err) if last_err else ""
        if "Cannot query field" in msg and "addInboundRoute" in msg:
            raise RuntimeError(
                "–ù–∞ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ FreePBX –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º—É—Ç–∞—Ü–∏—è addInboundRoute. "
                "–û–±–Ω–æ–≤–∏ –º–æ–¥—É–ª–∏ framework/core/api –¥–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤–µ—Ä—Å–∏–π."
            )
        raise RuntimeError(f"create_inbound_route failed: {last_err}")
    
    # ===== Inbound Routes: find =====
    def _try_fetch_inbound_routes(self) -> list:
        queries = [
            """
            query {
              fetchAllInboundRoutes {
                inboundRoute { id extension description destination }
              }
            }
            """,
            """
            query {
              inboundRoutes {
                inboundRoute { id extension description destination }
              }
            }
            """,
            """
            query {
              fetchInboundRoutes {
                inboundRoute { id extension description destination }
              }
            }
            """,
        ]
        last_err = None
        for q in queries:
            try:
                data = self.gql(q)
                # –ø—ã—Ç–∞–µ–º—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –ø–µ—Ä–≤—ã–π –≤—Å—Ç—Ä–µ—Ç–∏–≤—à–∏–π—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                for key in ("fetchAllInboundRoutes", "inboundRoutes", "fetchInboundRoutes"):
                    if key in data and data[key] and "inboundRoute" in data[key]:
                        arr = data[key]["inboundRoute"] or []
                        # normalize
                        out = []
                        for r in arr:
                            out.append({
                                "id": str(r.get("id")) if r.get("id") is not None else None,
                                "extension": str(r.get("extension") or "").strip(),
                                "description": str(r.get("description") or "").strip(),
                                "destination": str(r.get("destination") or "").strip(),
                            })
                        return out
            except Exception as e:
                last_err = e
                continue
        raise RuntimeError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ inbound routes: {last_err}")

    def find_inbound_route(self, did: str) -> Optional[dict]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ DID (extension) –∏–ª–∏ None.
        """
        did = str(did).strip()
        routes = self._try_fetch_inbound_routes()
        for r in routes:
            if r.get("extension") == did:
                return r
        return None

    def delete_inbound_route(self, route_id: str):
        q = """
        mutation ($input: removeInboundRouteInput!) {
        removeInboundRoute(input: $input) {
            status
            message
        }
        }
        """
        variables = {"input": {"id": route_id}}
        data = self.gql(q, variables)
        return data.get("removeInboundRoute") or {}
    
    def list_inbound_routes(self):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ inbound routes: id, extension, description
        """
        q = """
        query {
        allInboundRoutes {
            inboundRoutes {
            id
            extension
            description
            }
        }
        }
        """
        data = self.gql(q)
        conns = data.get("allInboundRoutes") or {}
        routes = conns.get("inboundRoutes") or []
        out = []
        for r in routes:
            out.append({
                "id": str(r.get("id") or ""),
                "extension": str(r.get("extension") or ""),
                "description": str(r.get("description") or ""),
            })
        return out
    
    def list_query_fields(self):
        q = """
        query {
        __schema {
            queryType {
            fields { name }
            }
        }
        }
        """
        data = self.gql(q)
        return [f["name"] for f in data["__schema"]["queryType"]["fields"]]
    
    def list_mutations(self):
        q = """
        query {
        __schema {
            mutationType {
            fields { name }
            }
        }
        }
        """
        data = self.gql(q)
        return [f["name"] for f in data["__schema"]["mutationType"]["fields"]]









handlers/callbacks.py:

from html import escape
from typing import List, Tuple

from telegram import Update
from telegram.ext import ContextTypes
from telegram.constants import ChatAction

from .commands import (
    _ensure_connected,
    fb_from_session,
    _slice_pairs,
)
from ui.texts import _list_nav_kb, _list_page_text
from utils.common import clean_url


async def list_nav_cb(u: Update, c: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ EXT.
    callback_data: "list:page:<N>"
    """
    q = u.callback_query
    data = q.data
    if not data.startswith("list:page:"):
        await q.answer()
        return

    try:
        page = int(data.split(":")[-1])

        # –ë–µ—Ä—ë–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
        pairs: List[Tuple[str, str]] = c.user_data.get("__last_pairs")
        fb = fb_from_session(u.effective_chat.id)
        if pairs is None:
            pairs = fb.fetch_all_extensions()
            c.user_data["__last_pairs"] = pairs

        pairs_page, page, pages = _slice_pairs(pairs, page=page)
        await q.message.edit_text(
            _list_page_text(clean_url(fb.base_url), pairs_page),
            reply_markup=_list_nav_kb(page, pages)
        )
        await q.answer()
    except Exception:
        await q.answer("–û—à–∏–±–∫–∞")


async def del_all_cb(u: Update, c: ContextTypes.DEFAULT_TYPE):
    """
    –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –ª–∏–Ω–∏–π.
    callback_data: "delall:yes" | "delall:no"
    """
    if not await _ensure_connected(u):
        return

    q = u.callback_query
    if not q.data.startswith("delall:"):
        await q.answer()
        return

    answer = q.data.split(":")[1]
    if answer == "no":
        await q.edit_message_text("–û—Ç–º–µ–Ω–µ–Ω–æ.")
        await q.answer("–û—Ç–º–µ–Ω–∞")
        return

    try:
        fb = fb_from_session(u.effective_chat.id)
        await q.edit_message_text("‚è≥ –£–¥–∞–ª—è—é –≤—Å–µ –ª–∏–Ω–∏–∏‚Ä¶ (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞)")
        pairs = fb.fetch_all_extensions()
        total = len(pairs)
        done = 0

        await q.message.chat.send_action(ChatAction.TYPING)
        for ext, _ in pairs:
            try:
                fb.delete_extension(ext)
            except Exception:
                pass
            done += 1
            if done % 25 == 0 or done == total:
                try:
                    await q.edit_message_text(f"‚è≥ –£–¥–∞–ª—è—é –≤—Å–µ –ª–∏–Ω–∏–∏‚Ä¶ ({done}/{total})")
                except Exception:
                    pass

        # Apply Config –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —É–¥–∞–ª–µ–Ω–∏–π
        if total:
            try:
                try:
                    await q.edit_message_text("üîÑ –ü—Ä–∏–º–µ–Ω—è—é –∫–æ–Ω—Ñ–∏–≥ (Apply Config)‚Ä¶")
                except Exception:
                    pass
                fb.apply_config()
            except Exception as e:
                try:
                    await q.edit_message_text(
                        f"–£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ, –Ω–æ Apply Config –Ω–µ —É–¥–∞–ª–æ—Å—å: <code>{escape(str(e))}</code>"
                    )
                except Exception:
                    pass
                await q.answer("–û—à–∏–±–∫–∞ Apply Config")
                return

        await q.edit_message_text(f"{fb.base_url}\n\n(–≤—Å—ë —É–¥–∞–ª–µ–Ω–æ)")
        await q.answer("–ì–æ—Ç–æ–≤–æ")
    except Exception as e:
        await q.edit_message_text(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: <code>{escape(str(e))}</code>")
        await q.answer("–û—à–∏–±–∫–∞")


async def noop_cb(u: Update, c: ContextTypes.DEFAULT_TYPE):
    """–ü—É—Å—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è 'noop'."""
    await u.callback_query.answer()
    


handlers/commands.py:

# src/handlers/commands.py
import os
import re
import time
import asyncio
import secrets
import logging
from html import escape
from typing import Dict, List, Tuple, Optional
from urllib.parse import urlparse
from telegram import BotCommand

from telegram import (
    Update, ReplyKeyboardMarkup, InlineKeyboardMarkup, InlineKeyboardButton,     
    BotCommand,
    BotCommandScopeAllPrivateChats,
    BotCommandScopeAllGroupChats,
    BotCommandScopeAllChatAdministrators,
    ReplyKeyboardRemove
    )
from telegram.ext import ContextTypes
from telegram.constants import ParseMode, ChatAction

from core.freepbx import FreePBX, AlreadyExists
from ui.texts import HELP_TEXT, _list_nav_kb, _list_page_text
from utils.common import clean_url, equip_start, parse_targets, next_free

from ui.keyboards import main_menu_kb

log = logging.getLogger(__name__)

# ----- Session / settings -----
SESS: Dict[int, dict] = {}
PAGE_SIZE = 50
ADMIN_CHAT_ID = os.getenv("ADMIN_CHAT_ID")


# ===== Internal helpers =====
def fb_from_session(chat_id: int) -> FreePBX:
    s = SESS.get(chat_id)
    if not s:
        raise RuntimeError("–°–Ω–∞—á–∞–ª–∞ /connect <ip> <login> <password>")
    fb = FreePBX(s["base_url"], s["client_id"], s["client_secret"], verify=s["verify"])
    fb.token = s.get("token")
    fb.token_exp = s.get("token_exp", 0)
    return fb

def _need_connect_text() -> str:
    return "–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å:\n<code>/connect &lt;ip&gt; &lt;login&gt; &lt;password&gt;</code>"

async def _ensure_connected(u: Update) -> bool:
    chat = u.effective_chat
    if chat and chat.id in SESS:
        return True
    if getattr(u, "message", None):
        await u.message.reply_text(_need_connect_text())
    elif getattr(u, "callback_query", None):
        await u.callback_query.answer("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å: /connect <ip> <login> <password>", show_alert=True)
    return False

def _slice_pairs(pairs, page: int, page_size: int = PAGE_SIZE):
    total = len(pairs)
    pages = max(1, (total + page_size - 1) // page_size)
    page = max(0, min(page, pages - 1))
    start = page * page_size
    end = start + page_size
    return pairs[start:end], page, pages


# ===== Commands =====
async def start_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    # –°–Ω–∞—á–∞–ª–∞ —É–±–µ—Ä—ë–º —Å—Ç–∞—Ä—É—é reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É, –µ—Å–ª–∏ –±—ã–ª–∞
    await u.message.reply_text(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É —É–ø—Ä–∞–≤–ª—è—Ç—å FreePBX: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, —Å–ø–∏—Å–æ–∫ SIP, —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ.\n"
        "–ù–∞–±–µ—Ä–∏ /help –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.",
        reply_markup=ReplyKeyboardRemove()
    )
    # –ò —Å—Ä–∞–∑—É –ø–æ–∫–∞–∂–µ–º inline-–≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    await u.message.reply_text(
        "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>",
        parse_mode=ParseMode.HTML,
        reply_markup=main_menu_kb(),
    )

async def help_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    await u.message.reply_text(HELP_TEXT)


async def connect_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    if len(c.args) < 3:
        await u.message.reply_text(
            "–§–æ—Ä–º–∞—Ç:\n"
            "<code>/connect &lt;ip&gt; &lt;login&gt; &lt;password&gt;</code>\n"
            "–ü—Ä–∏–º–µ—Ä: <code>/connect http://77.105.146.189 CID SECRET</code>"
        )
        return

    raw_ip, login, password = c.args[0], c.args[1], c.args[2]
    parsed = urlparse(raw_ip)
    if not parsed.scheme:
        base_url = f"http://{raw_ip}"
        verify = False
    else:
        base_url = raw_ip
        verify = not base_url.startswith("http://")

    await u.message.chat.send_action(ChatAction.TYPING)
    fb = FreePBX(base_url, login, password, verify=verify)

    try:
        fb.ensure_token()
        SESS[u.effective_chat.id] = {
            "base_url": fb.base_url,
            "client_id": login,
            "client_secret": password,
            "verify": verify,
            "token": fb.token,
            "token_exp": fb.token_exp,
        }

        # —Å—Ç–∞–≤–∏–º —Ñ–ª–∞–≥ –¥–ª—è –º–µ–Ω—é
        c.user_data["__connected"] = True

        pairs = fb.fetch_all_extensions()
        c.user_data["__last_pairs"] = pairs
        pairs_page, page, pages = _slice_pairs(pairs, page=0)
        text = _list_page_text(clean_url(fb.base_url), pairs_page)
        kb = _list_nav_kb(page, pages)

        await u.message.reply_text(f"‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ <code>{escape(fb.base_url)}</code>")

        # –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        await u.message.reply_text(
            "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>",
            parse_mode=ParseMode.HTML,
            reply_markup=main_menu_kb(),
        )

        # (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ) —Å–ø–∏—Å–æ–∫ —ç–∫—Å—Ç–µ–Ω—à–µ–Ω–æ–≤
        await u.message.reply_text(text, reply_markup=kb)

    except Exception as e:
        await u.message.reply_text(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: <code>{escape(str(e))}</code>")


async def list_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    if not await _ensure_connected(u):
        return
    try:
        fb = fb_from_session(u.effective_chat.id)
        pairs = fb.fetch_all_extensions()
        c.user_data["__last_pairs"] = pairs
        pairs_page, page, pages = _slice_pairs(pairs, page=0)

        target = u.effective_message  # —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ü–µ–ª—å –æ—Ç–≤–µ—Ç–∞
        await target.reply_text(
            _list_page_text(clean_url(fb.base_url), pairs_page),
            reply_markup=_list_nav_kb(page, pages)
        )
    except Exception as e:
        target = u.effective_message
        await target.reply_text(f"–û—à–∏–±–∫–∞: <code>{escape(str(e))}</code>")


async def create_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    target = u.effective_message  # —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è "—Ç–æ—á–∫–∞ –æ—Ç–≤–µ—Ç–∞" (–∏ –¥–ª—è message, –∏ –¥–ª—è callback)

    if len(c.args) < 2:
        await target.reply_text(
            "‚ùó –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã:\n"
            "<code>/create &lt;–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ&gt; &lt;–∫–æ–ª-–≤–æ&gt;</code>\n\n"
            "–ì–¥–µ <b>–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</b> ‚Äî –Ω–æ–º–µ—Ä –±–∞–∑—ã (—Å—Ç–∞—Ä—Ç EXT):\n"
            "‚Ä¢ 1 ‚Üí 101‚Ä¶\n‚Ä¢ 2 ‚Üí 201‚Ä¶\n‚Ä¢ 3 ‚Üí 301‚Ä¶\n‚Ä¢ 4 ‚Üí 401‚Ä¶\n‚Ä¢ 10 ‚Üí 1001‚Ä¶\n\n"
            "–ü—Ä–∏–º–µ—Ä:\n<code>/create 4 10</code> ‚Äî —Å–æ–∑–¥–∞—Å—Ç 10 –ª–∏–Ω–∏–π, –Ω–∞—á–∏–Ω–∞—è —Å 401.\n",
        )
        return

    if not await _ensure_connected(u):
        return

    try:
        eq = int(c.args[0])
        cnt = int(c.args[1])
        if cnt <= 0:
            raise ValueError
    except Exception:
        await target.reply_text(
            "‚ùó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π: <code>/create &lt;–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ&gt; &lt;–∫–æ–ª-–≤–æ&gt;</code>\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: <code>/create 4 10</code>"
        )
        return

    fb = fb_from_session(u.effective_chat.id)
    try:
        notice = await target.reply_text(f"‚è≥ –°–æ–∑–¥–∞—é {cnt} –ª–∏–Ω–∏–π‚Ä¶ (0/{cnt})")
        await target.chat.send_action(ChatAction.TYPING)

        all_pairs = fb.fetch_all_extensions()
        existing = [ext for ext, _ in all_pairs]
        start = equip_start(eq)
        targets = next_free(existing, start, cnt)

        created = 0
        for i, ext in enumerate(targets, 1):
            fb.create_one(int(ext))
            secret = secrets.token_hex(16)
            fb.set_ext_password(ext, secret)

            created += 1
            if created % 5 == 0 or created == cnt:
                try:
                    await notice.edit_text(f"‚è≥ –°–æ–∑–¥–∞—é {cnt} –ª–∏–Ω–∏–π‚Ä¶ ({created}/{cnt})")
                except Exception:
                    pass
            await asyncio.sleep(0)

        if targets:
            try:
                try:
                    await notice.edit_text("üîÑ –ü—Ä–∏–º–µ–Ω—è—é –∫–æ–Ω—Ñ–∏–≥ (Apply Config)‚Ä¶")
                except Exception:
                    pass
                fb.apply_config()
                try:
                    await notice.edit_text("‚úÖ –ö–æ–Ω—Ñ–∏–≥ –ø—Ä–∏–º–µ–Ω—ë–Ω. –û–±–Ω–æ–≤–ª—è—é —Å–ø–∏—Å–æ–∫‚Ä¶")
                except Exception:
                    pass
            except Exception as e:
                await target.reply_text(f"‚ö†Ô∏è Apply Config –Ω–µ —É–¥–∞–ª–æ—Å—å: <code>{escape(str(e))}</code>")

        pairs = fb.fetch_all_extensions()
        c.user_data["__last_pairs"] = pairs
        pairs_page, page, pages = _slice_pairs(pairs, page=0)

        await target.reply_text(
            _list_page_text(clean_url(fb.base_url), pairs_page),
            reply_markup=_list_nav_kb(page, pages)
        )
    except Exception as e:
        await target.reply_text(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: <code>{escape(str(e))}</code>")


async def del_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    target = u.effective_message
    if not c.args:
        await target.reply_text("–§–æ—Ä–º–∞—Ç: /del 401 402 410-418")
        return
    if not await _ensure_connected(u):
        return

    fb = fb_from_session(u.effective_chat.id)
    requested = parse_targets(" ".join(c.args))
    try:
        await target.chat.send_action(ChatAction.TYPING)
        by_ext, _, _ = fb.fetch_ext_index()
        existing = set(by_ext.keys())

        targets = [x for x in requested if x in existing]
        missing = [x for x in requested if x not in existing]

        total = len(targets)
        notice = await target.reply_text(f"‚è≥ –£–¥–∞–ª—è—é –ª–∏–Ω–∏–∏‚Ä¶ (0/{total})") if total else None

        ok, failed = [], []
        for i, ext in enumerate(targets, 1):
            try:
                fb.delete_extension(ext)
                ok.append(ext)
            except Exception:
                failed.append(ext)
            if notice and (i % 10 == 0 or i == total):
                try:
                    await notice.edit_text(f"‚è≥ –£–¥–∞–ª—è—é –ª–∏–Ω–∏–∏‚Ä¶ ({i}/{total})")
                except Exception:
                    pass
            await asyncio.sleep(0)

        parts = []
        if ok:      parts.append("üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ: " + ", ".join(ok))
        if missing: parts.append("‚Ü©Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (–Ω–µ—Ç —Ç–∞–∫–æ–π –ª–∏–Ω–∏–∏): " + ", ".join(missing))
        if failed:  parts.append("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + ", ".join(failed))
        if not parts: parts.append("–ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å.")
        await target.reply_text("\n".join(parts))

        if ok:
            try:
                if notice:
                    try: await notice.edit_text("üîÑ –ü—Ä–∏–º–µ–Ω—è—é –∫–æ–Ω—Ñ–∏–≥ (Apply Config)‚Ä¶")
                    except Exception: pass
                fb.apply_config()
                if notice:
                    try: await notice.edit_text("‚úÖ –ö–æ–Ω—Ñ–∏–≥ –ø—Ä–∏–º–µ–Ω—ë–Ω. –û–±–Ω–æ–≤–ª—è—é —Å–ø–∏—Å–æ–∫‚Ä¶")
                    except Exception: pass
            except Exception as e:
                await target.reply_text(f"‚ö†Ô∏è Apply Config –Ω–µ —É–¥–∞–ª–æ—Å—å: <code>{escape(str(e))}</code>")

        pairs = fb.fetch_all_extensions()
        c.user_data["__last_pairs"] = pairs
        page_items, page, pages = _slice_pairs(pairs, page=0)
        await target.reply_text(
            _list_page_text(clean_url(fb.base_url), page_items),
            reply_markup=_list_nav_kb(page, pages)
        )
    except Exception as e:
        await target.reply_text(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: <code>{escape(str(e))}</code>")

async def del_eq_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    target = u.effective_message
    if not c.args:
        await target.reply_text("–§–æ—Ä–º–∞—Ç: /del_eq <–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ>")
        return
    if not await _ensure_connected(u):
        return
    eq = int(c.args[0])
    start = equip_start(eq)
    end = start + 99
    c.args = [f"{start}-{end}"]
    await del_cmd(u, c)

async def del_all_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    if not await _ensure_connected(u):
        return
    kb = InlineKeyboardMarkup([
        [InlineKeyboardButton("–î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å—ë", callback_data="delall:yes"),
         InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="delall:no")]
    ])
    await u.message.reply_text("‚ö†Ô∏è –¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –ª–∏–Ω–∏–∏?", reply_markup=kb)

async def add_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    if not c.args:
        await u.message.reply_text(
            "–§–æ—Ä–º–∞—Ç—ã:\n"
            "<code>/add &lt;ext&gt; [–∏–º—è]</code>\n"
            "<code>/add &lt;start-end&gt; [–ø—Ä–µ—Ñ–∏–∫—Å_–∏–º–µ–Ω–∏]</code>\n"
            "–ü—Ä–∏–º–µ—Ä—ã:\n"
            "<code>/add 101</code>\n"
            "<code>/add 101 –û—Ñ–∏—Å –ö–∏–µ–≤</code>\n"
            "<code>/add 101-105 –ü—Ä–æ–¥–∞–∂–∏</code>"
        )
        return
    if not await _ensure_connected(u):
        return

    fb = fb_from_session(u.effective_chat.id)
    arg0 = c.args[0]
    name_tail = " ".join(c.args[1:]).strip()
    try:
        await u.message.chat.send_action(ChatAction.TYPING)

        targets = parse_targets(arg0) if "-" in arg0 else [arg0]
        total = len(targets)
        notice = await u.message.reply_text(f"‚è≥ –î–æ–±–∞–≤–ª—è—é –ª–∏–Ω–∏–∏‚Ä¶ (0/{total})")

        by_ext, name_set, name_ok = fb.fetch_ext_index()
        existing_exts = set(by_ext.keys())

        created, skipped_ext, skipped_name = [], [], []
        name_check_warn = False

        processed = 0
        for raw in targets:
            ext = str(int(raw))
            cand_name = (f"{name_tail} {ext}" if "-" in arg0 else name_tail) if name_tail else ext

            if ext in existing_exts:
                skipped_ext.append(ext)
            elif name_ok and cand_name.strip().lower() in name_set:
                skipped_name.append(f"{ext} ({cand_name})")
            else:
                if not name_ok:
                    name_check_warn = True
                fb.create_one(int(ext), cand_name)
                secret = secrets.token_hex(16)
                fb.set_ext_password(ext, secret)
                created.append(ext)
                existing_exts.add(ext)
                if name_ok and cand_name.strip():
                    name_set.add(cand_name.strip().lower())

            processed += 1
            if processed % 5 == 0 or processed == total:
                try:
                    await notice.edit_text(f"‚è≥ –î–æ–±–∞–≤–ª—è—é –ª–∏–Ω–∏–∏‚Ä¶ ({processed}/{total})")
                except Exception:
                    pass
            await asyncio.sleep(0)

        parts = []
        if created:
            parts.append("‚úÖ –°–æ–∑–¥–∞–Ω–æ: " + ", ".join(created))
        if skipped_ext:
            parts.append("‚Ü©Ô∏è –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç EXT: " + ", ".join(skipped_ext))
        if skipped_name:
            parts.append("üîÅ –î—É–±–ª–∏ –∏–º—ë–Ω: " + ", ".join(skipped_name))
        if name_check_warn:
            parts.append("‚ÑπÔ∏è –ò–º—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å (—Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–¥–∞—ë—Ç –∏–º–µ–Ω–∞).")
        if not parts:
            parts.append("–ù–µ—á–µ–≥–æ –¥–µ–ª–∞—Ç—å.")
        await u.message.reply_text("\n".join(parts))

        if created:
            try:
                try:
                    await notice.edit_text("üîÑ –ü—Ä–∏–º–µ–Ω—è—é –∫–æ–Ω—Ñ–∏–≥ (Apply Config)‚Ä¶")
                except Exception:
                    pass
                fb.apply_config()
                try:
                    await notice.edit_text("‚úÖ –ö–æ–Ω—Ñ–∏–≥ –ø—Ä–∏–º–µ–Ω—ë–Ω. –û–±–Ω–æ–≤–ª—è—é —Å–ø–∏—Å–æ–∫‚Ä¶")
                except Exception:
                    pass
            except Exception as e:
                await u.message.reply_text(f"‚ö†Ô∏è Apply Config –Ω–µ —É–¥–∞–ª–æ—Å—å: <code>{escape(str(e))}</code>")

        pairs = fb.fetch_all_extensions()
        c.user_data["__last_pairs"] = pairs
        page_items, page, pages = _slice_pairs(pairs, page=0)
        await u.message.reply_text(
            _list_page_text(clean_url(fb.base_url), page_items),
            reply_markup=_list_nav_kb(page, pages)
        )
    except Exception as e:
        await u.message.reply_text(f"–û—à–∏–±–∫–∞ /add: <code>{escape(str(e))}</code>")

async def reconnect_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    if not await _ensure_connected(u):
        return
    try:
        target = u.effective_message
        s = SESS.get(u.effective_chat.id)
        fb = FreePBX(s["base_url"], s["client_id"], s["client_secret"], verify=s["verify"])
        fb.ensure_token()
        s["token"] = fb.token
        s["token_exp"] = fb.token_exp
        await target.reply_text("üîÅ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.")
    except Exception as e:
        await target.reply_text(f"–û—à–∏–±–∫–∞ reconnect: <code>{escape(str(e))}</code>")

async def ping_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    if not await _ensure_connected(u):
        return
    try:
        target = u.effective_message
        fb = fb_from_session(u.effective_chat.id)
        fb.ensure_token()
        _ = fb.gql("query { fetchAllExtensions { extension { extensionId } } }")
        await target.reply_text("‚úÖ OK")
    except Exception as e:
        await target.reply_text(f"‚ùå Unauthorized / –æ—à–∏–±–∫–∞: <code>{escape(str(e))}</code>")

async def whoami_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    if not await _ensure_connected(u):
        return
    target = u.effective_message
    s = SESS.get(u.effective_chat.id)
    ttl = max(0, int(s.get("token_exp", 0) - time.time()))
    await target.reply_text(
        "üë§ –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è\n"
        f"URL: <code>{s['base_url']}</code>\n"
        f"Client ID: <code>{s['client_id']}</code>\n"
        f"TLS verify: <code>{s['verify']}</code>\n"
        f"–¢–æ–∫–µ–Ω –∂–∏–≤ –µ—â—ë: <code>{ttl} —Å–µ–∫</code>"
    )

async def logout_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    target = u.effective_message
    SESS.pop(u.effective_chat.id, None)
    c.user_data.clear()
    await target.reply_text("üö™ –°–µ—Å—Å–∏—è —Å–±—Ä–æ—à–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /connect.")

async def list_routes_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    if not await _ensure_connected(u):
        return
    fb = fb_from_session(u.effective_chat.id)
    target = u.effective_message
    try:
        routes = fb.list_inbound_routes()
        if not routes:
            await target.reply_text("–ú–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
            return
        lines = ["DID | Description | ID"]
        for r in routes:
            did = r.get("extension")
            desc = r.get("description")
            rid = r.get("id")
            lines.append(f"{did} | {desc} | {rid}")
        await target.reply_text("\n".join(lines))
    except Exception as e:
        await target.reply_text(f"–û—à–∏–±–∫–∞ /list_routes: <code>{escape(str(e))}</code>")



async def add_inbound_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    """
    /add_inbound 414
    /add_inbound 414-420
    –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ EXT —Å–æ–∑–¥–∞—ë–º inbound route:
    DID=_sim{ext}, Description=sim{ext}, Destination -> Extension {ext}
    """
    target = u.effective_message

    if not c.args:
        await target.reply_text(
            "–§–æ—Ä–º–∞—Ç—ã:\n"
            "<code>/add_inbound &lt;ext&gt;</code>\n"
            "<code>/add_inbound &lt;start-end&gt;</code>\n"
            "–ü—Ä–∏–º–µ—Ä—ã:\n"
            "<code>/add_inbound 414</code>\n"
            "<code>/add_inbound 401-418</code>\n"
            "–ú–∞—Ä—à—Ä—É—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ EXT —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. DID –±—É–¥–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ <code>_simEXT</code>."
        )
        return
    if not await _ensure_connected(u):
        return

    fb = fb_from_session(u.effective_chat.id)
    arg0 = " ".join(c.args)
    targets = parse_targets(arg0)

    try:
        await target.chat.send_action(ChatAction.TYPING)

        # –ò–Ω–¥–µ–∫—Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö EXT
        by_ext, _, _ = fb.fetch_ext_index()
        existing_exts = set(by_ext.keys())

        # –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ DID —É –º–∞—Ä—à—Ä—É—Ç–æ–≤ (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–µ–π, —É—á–∏—Ç—ã–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞)
        routes_now = fb.list_inbound_routes()
        existing_dids = {r.get("extension") for r in routes_now if r.get("extension")}

        todo = [x for x in targets if x in existing_exts]
        missing = [x for x in targets if x not in existing_exts]

        total = len(todo)
        if total == 0:
            msg = ["–ù–µ—á–µ–≥–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å."]
            if missing:
                msg.append("‚Ü©Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (–Ω–µ—Ç —Ç–∞–∫–∏—Ö EXT): " + ", ".join(missing))
            await target.reply_text("\n".join(msg))
            return

        notice = await target.reply_text(f"‚è≥ –î–æ–±–∞–≤–ª—è—é Inbound Routes‚Ä¶ (0/{total})")

        ok, skipped_exists, failed = [], [], []
        for i, ext in enumerate(todo, 1):
            did_plain = ext
            did_prefx = f"_sim{ext}"
            # –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–π –º–∞—Ä—à—Ä—É—Ç (DID=ext) –∏–ª–∏ –Ω–æ–≤—ã–π (DID=_simext) ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏–º
            if did_plain in existing_dids or did_prefx in existing_dids:
                skipped_exists.append(ext)
            else:
                try:
                    fb.create_inbound_route(did=did_prefx, description=f"sim{ext}", ext=ext)
                    ok.append(ext)
                    existing_dids.add(did_prefx)
                except AlreadyExists:
                    skipped_exists.append(ext)
                except Exception as e:
                    failed.append(f"{ext} ({str(e)[:80]})")

            if i % 5 == 0 or i == total:
                try:
                    await notice.edit_text(f"‚è≥ –î–æ–±–∞–≤–ª—è—é Inbound Routes‚Ä¶ ({i}/{total})")
                except Exception:
                    pass
            await asyncio.sleep(0)

        parts = []
        if ok:
            parts.append("‚úÖ –°–æ–∑–¥–∞–Ω–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤: " + ", ".join(ok))
        if skipped_exists:
            parts.append("‚Ü©Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ –µ—Å—Ç—å DID ext –∏–ª–∏ _simext): " + ", ".join(skipped_exists))
        if missing:
            parts.append("‚Ü©Ô∏è –ù–µ—Ç —Ç–∞–∫–∏—Ö EXT: " + ", ".join(missing))
        if failed:
            parts.append("‚ùå –û—à–∏–±–∫–∏: " + ", ".join(failed))
        await target.reply_text("\n".join(parts) if parts else "–ù–µ—á–µ–≥–æ –¥–µ–ª–∞—Ç—å.")

        if ok:
            try:
                try:
                    await notice.edit_text("üîÑ –ü—Ä–∏–º–µ–Ω—è—é –∫–æ–Ω—Ñ–∏–≥ (Apply Config)‚Ä¶")
                except Exception:
                    pass
                fb.apply_config()
                try:
                    await notice.edit_text("‚úÖ –ö–æ–Ω—Ñ–∏–≥ –ø—Ä–∏–º–µ–Ω—ë–Ω.")
                except Exception:
                    pass
            except Exception as e:
                await target.reply_text(f"‚ö†Ô∏è Apply Config –Ω–µ —É–¥–∞–ª–æ—Å—å: <code>{escape(str(e))}</code>")

    except Exception as e:
        await target.reply_text(f"–û—à–∏–±–∫–∞ /add_inbound: <code>{escape(str(e))}</code>")


async def del_inbound_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    """
    /del_inbound <ext>
    –£–¥–∞–ª—è–µ—Ç inbound route –ø–æ extension (DID).
    –ü—Ä–∏–Ω–∏–º–∞–µ–º EXT –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞, –∞ –∏—â–µ–º DID –∏ –∫–∞–∫ _simEXT, –∏ –∫–∞–∫ —Å—Ç–∞—Ä—ã–π EXT.
    """
    target = u.effective_message

    if not c.args:
        await target.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: <code>/del_inbound &lt;ext&gt;</code>")
        return
    if not await _ensure_connected(u):
        return

    fb = fb_from_session(u.effective_chat.id)
    number = c.args[0]

    try:
        await target.chat.send_action(ChatAction.TYPING)

        routes = fb.list_inbound_routes()
        did_new = f"_sim{number}"
        # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
        route = next((r for r in routes if r.get("extension") == did_new), None)
        # –ó–∞—Ç–µ–º ‚Äî —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        if not route:
            route = next((r for r in routes if r.get("extension") == number), None)

        if not route:
            await target.reply_text(f"‚ùå –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è EXT {number} –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–∏ DID={did_new}, –Ω–∏ DID={number})")
            return

        shown = route.get("extension") or number
        notice = await target.reply_text(f"‚è≥ –£–¥–∞–ª—è—é Inbound Route {shown}‚Ä¶")

        res = fb.delete_inbound_route(route["id"])
        status = (res.get("status") if isinstance(res, dict) else None)
        msg = (res.get("message") if isinstance(res, dict) else "") or ""

        status_str = str(status).lower() if status is not None else ""
        okish = status_str in ("ok", "true") or "success" in msg.lower()

        if okish:
            await notice.edit_text(f"‚úÖ –ú–∞—Ä—à—Ä—É—Ç {shown} —É–¥–∞–ª—ë–Ω. üîÑ –ü—Ä–∏–º–µ–Ω—è—é –∫–æ–Ω—Ñ–∏–≥‚Ä¶")
            try:
                fb.apply_config()
                await notice.edit_text(f"‚úÖ –ú–∞—Ä—à—Ä—É—Ç {shown} —É–¥–∞–ª—ë–Ω.\n‚úÖ –ö–æ–Ω—Ñ–∏–≥ –ø—Ä–∏–º–µ–Ω—ë–Ω.")
            except Exception as e:
                await notice.edit_text(
                    f"‚úÖ –ú–∞—Ä—à—Ä—É—Ç {shown} —É–¥–∞–ª—ë–Ω.\n‚ö†Ô∏è Apply Config –Ω–µ —É–¥–∞–ª–æ—Å—å: {escape(str(e))}"
                )
        else:
            await notice.edit_text(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è {shown}: {msg or res}")

    except Exception as e:
        await target.reply_text(f"–û—à–∏–±–∫–∞ /del_inbound: <code>{escape(str(e))}</code>")



async def gql_fields_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    if not await _ensure_connected(u):
        return
    fb = fb_from_session(u.effective_chat.id)
    target = u.effective_message
    try:
        fields = fb.list_query_fields()
        if not fields:
            await target.reply_text("Query-–ø–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
            return
        chunk = []
        total = 0
        for f in fields:
            line = f"- {f}"
            if sum(len(x) for x in chunk) + len(line) + 1 > 3500:
                await target.reply_text("–î–æ—Å—Ç—É–ø–Ω—ã–µ Query:\n" + "\n".join(chunk))
                chunk = []
            chunk.append(line)
            total += 1
        if chunk:
            await target.reply_text("–î–æ—Å—Ç—É–ø–Ω—ã–µ Query:\n" + "\n".join(chunk))
    except Exception as e:
        await target.reply_text(f"–û—à–∏–±–∫–∞ introspect: {escape(str(e))}")
        

async def gql_mutations_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    if not await _ensure_connected(u):
        return
    fb = fb_from_session(u.effective_chat.id)
    target = u.effective_message
    try:
        muts = fb.list_mutations()
        if not muts:
            await target.reply_text("Mutation-–ø–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
            return
        chunk = []
        total = 0
        for m in muts:
            line = f"- {m}"
            if sum(len(x) for x in chunk) + len(line) + 1 > 3500:
                await target.reply_text("–î–æ—Å—Ç—É–ø–Ω—ã–µ Mutation:\n" + "\n".join(chunk))
                chunk = []
            chunk.append(line)
            total += 1
        if chunk:
            await target.reply_text("–î–æ—Å—Ç—É–ø–Ω—ã–µ Mutation:\n" + "\n".join(chunk))
    except Exception as e:
        await target.reply_text(f"–û—à–∏–±–∫–∞ introspect: {escape(str(e))}")
        
async def menu_cmd(u: Update, c: ContextTypes.DEFAULT_TYPE):
    if not await _ensure_connected(u):
        return
    target = u.effective_message
    await target.reply_text(
        "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>",
        parse_mode=ParseMode.HTML,
        reply_markup=main_menu_kb(),
    )

# ===== Lifecycle hook (used in main.py via .post_init(on_startup)) =====
async def on_startup(app):
    print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –ù–∞–±–µ—Ä–∏ /help –≤ Telegram –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.")
    log.info("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏: /help")

    if ADMIN_CHAT_ID:
        try:
            await app.bot.send_message(int(ADMIN_CHAT_ID), "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –ù–∞–ø–∏—à–∏—Ç–µ /help.")
        except Exception as e:
            log.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É: {e}")

    try:
        await app.bot.delete_my_commands()  # default
        await app.bot.delete_my_commands(scope=BotCommandScopeAllPrivateChats())
        await app.bot.delete_my_commands(scope=BotCommandScopeAllGroupChats())
        await app.bot.delete_my_commands(scope=BotCommandScopeAllChatAdministrators())

        commands = [
            BotCommand("start", "–ó–∞–ø—É—Å–∫"),
            BotCommand("help", "–ü–æ–º–æ—â—å"),
            BotCommand("connect", "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ FreePBX"),
            BotCommand("menu", "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
            BotCommand("list", "–°–ø–∏—Å–æ–∫ EXT"),
            BotCommand("create", "–°–æ–∑–¥–∞—Ç—å –ø–æ –±–∞–∑–µ"),
            BotCommand("add", "–î–æ–±–∞–≤–∏—Ç—å EXT/–¥–∏–∞–ø–∞–∑–æ–Ω"),
            BotCommand("del", "–£–¥–∞–ª–∏—Ç—å EXT/–¥–∏–∞–ø–∞–∑–æ–Ω"),
            BotCommand("del_eq", "–£–¥–∞–ª–∏—Ç—å –ø–æ –±–∞–∑–µ (100 –Ω–æ–º–µ—Ä–æ–≤)"),
            BotCommand("del_all", "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ EXT"),
            BotCommand("add_inbound", "–°–æ–∑–¥–∞—Ç—å inbound (EXT/–¥–∏–∞–ø–∞–∑–æ–Ω)"),
            BotCommand("del_inbound", "–£–¥–∞–ª–∏—Ç—å inbound –ø–æ DID"),
            BotCommand("list_routes", "–°–ø–∏—Å–æ–∫ inbound –º–∞—Ä—à—Ä—É—Ç–æ–≤"),
            BotCommand("reconnect", "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"),
            BotCommand("ping", "–ü—Ä–æ–≤–µ—Ä–∫–∞ GraphQL"),
            BotCommand("whoami", "–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è"),
            BotCommand("logout", "–°–±—Ä–æ—Å —Å–µ—Å—Å–∏–∏"),
        ]

        await app.bot.set_my_commands(commands)  # default
        await app.bot.set_my_commands(commands, scope=BotCommandScopeAllPrivateChats())
        await app.bot.set_my_commands(commands, scope=BotCommandScopeAllGroupChats())
        await app.bot.set_my_commands(commands, scope=BotCommandScopeAllChatAdministrators())

        try:
            await app.bot.set_chat_menu_button()  # –≤–µ—Ä–Ω—ë—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é ¬´–≥–æ–ª—É–±—É—é¬ª –∫–Ω–æ–ø–∫—É
        except Exception:
            pass
    except Exception as e:
        print(f"set_my_commands failed: {e}")

handlers/menu.py:

from telegram import Update
from telegram.constants import ParseMode
from telegram.ext import ContextTypes
from telegram.error import BadRequest

from ui.keyboards import (
    MENU_PREFIX, main_menu_kb, back_home_kb,
    ext_menu_kb, in_menu_kb, sys_menu_kb, gql_menu_kb
)
from ui.texts import NOT_CONNECTED

from handlers.commands import (
    list_cmd, create_cmd, add_cmd, del_cmd, 
    reconnect_cmd, ping_cmd, whoami_cmd, logout_cmd, 
    gql_fields_cmd, gql_mutations_cmd,
    list_routes_cmd, add_inbound_cmd, del_inbound_cmd
)

from utils.common import equip_start
# ===== helpers =====

def _is_connected(context: ContextTypes.DEFAULT_TYPE) -> bool:
    return bool(context.user_data.get("__connected"))

async def _safe_edit(q, text, **kwargs):
    try:
        return await q.edit_message_text(text, **kwargs)
    except BadRequest as e:
        if "message is not modified" in str(e).lower():
            return None
        raise

def _mk_inline(spec_rows):
    from telegram import InlineKeyboardMarkup, InlineKeyboardButton
    rows = []
    for row in spec_rows:
        rows.append([InlineKeyboardButton(b["text"], callback_data=b["data"]) for b in row])
    return InlineKeyboardMarkup(rows)

async def send_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    target = update.effective_message
    await target.reply_text(
        "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>",
        parse_mode=ParseMode.HTML,
        reply_markup=main_menu_kb(),
    )


# ===== –≠–ö–†–ê–ù–´: –°–æ–∑–¥–∞–Ω–∏–µ =====

async def _ext_create_root(q, *, text_suffix: str = ""):
    txt = (
        "‚ûï <b>–°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–Ω–∏–π</b>\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±:\n\n"
        "‚Ä¢ –ü–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4 ‚Üí 401‚Ä¶)\n"
        "‚Ä¢ –û–¥–∏–Ω –Ω–æ–º–µ—Ä (EXT)\n"
        "‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω (start-end)\n"
    )
    if text_suffix:
        txt += f"\n<code>{text_suffix}</code>"
    kb = [
        [dict(text="üè≠ –ü–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é", data=f"{MENU_PREFIX}ext.create.eq")],
        [
            dict(text="1Ô∏è‚É£ –û–¥–∏–Ω –Ω–æ–º–µ—Ä", data=f"{MENU_PREFIX}ext.create.single"),
            dict(text="‚ÜîÔ∏è –î–∏–∞–ø–∞–∑–æ–Ω",    data=f"{MENU_PREFIX}ext.create.range"),
        ],
        [dict(text="üîô –ù–∞–∑–∞–¥", data=f"{MENU_PREFIX}ext")],
    ]
    await _safe_edit(q, txt, parse_mode=ParseMode.HTML, reply_markup=_mk_inline(kb))

async def _ext_create_pick_eq(q):
    txt = "üè≠ –í—ã–±–µ—Ä–∏—Ç–µ <b>–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</b> (—Å—Ç–∞—Ä—Ç–æ–≤–∞—è –±–∞–∑–∞ EXT):"
    kb = [
        [
            dict(text="1 ‚Üí 101‚Ä¶", data=f"{MENU_PREFIX}ext.create.eq.1"),
            dict(text="2 ‚Üí 201‚Ä¶", data=f"{MENU_PREFIX}ext.create.eq.2"),
        ],
        [
            dict(text="3 ‚Üí 301‚Ä¶", data=f"{MENU_PREFIX}ext.create.eq.3"),
            dict(text="4 ‚Üí 401‚Ä¶", data=f"{MENU_PREFIX}ext.create.eq.4"),
        ],
        [dict(text="10 ‚Üí 1001‚Ä¶", data=f"{MENU_PREFIX}ext.create.eq.10")],
        [dict(text="‚úçÔ∏è –í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –±–∞–∑—ã", data=f"{MENU_PREFIX}ext.create.eq.custom")],  # ‚Üê –ù–û–í–û–ï
        [dict(text="üîô –ù–∞–∑–∞–¥",   data=f"{MENU_PREFIX}ext.create")],
    ]
    await _safe_edit(q, txt, parse_mode=ParseMode.HTML,
                     reply_markup=_mk_inline(kb))


async def _ext_create_pick_qty(q, eq: int):
    txt = f"üì¶ –ë–∞–∑–∞ <b>{eq}</b>. –í—ã–±–µ—Ä–∏—Ç–µ <b>–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</b> –ª–∏–Ω–∏–π:"
    kb = [
        [
            dict(text="1",  data=f"{MENU_PREFIX}ext.create.eqqty.{eq}.1"),
            dict(text="5",  data=f"{MENU_PREFIX}ext.create.eqqty.{eq}.5"),
            dict(text="10", data=f"{MENU_PREFIX}ext.create.eqqty.{eq}.10"),
        ],
        [
            dict(text="20",            data=f"{MENU_PREFIX}ext.create.eqqty.{eq}.20"),
            dict(text="50",            data=f"{MENU_PREFIX}ext.create.eqqty.{eq}.50"),
            dict(text="‚úçÔ∏è –í–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ", data=f"{MENU_PREFIX}ext.create.eqqty.custom.{eq}"),
        ],
        [dict(text="üîô –ù–∞–∑–∞–¥", data=f"{MENU_PREFIX}ext.create.eq")],
    ]
    await _safe_edit(q, txt, parse_mode=ParseMode.HTML, reply_markup=_mk_inline(kb))
    
async def _ext_create_pick_qty_send(target_message, eq: int):
    txt = f"üì¶ –ë–∞–∑–∞ <b>{eq}</b>. –í—ã–±–µ—Ä–∏—Ç–µ <b>–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</b> –ª–∏–Ω–∏–π:"
    kb = [
        [
            dict(text="1",  data=f"{MENU_PREFIX}ext.create.eqqty.{eq}.1"),
            dict(text="5",  data=f"{MENU_PREFIX}ext.create.eqqty.{eq}.5"),
            dict(text="10", data=f"{MENU_PREFIX}ext.create.eqqty.{eq}.10"),
        ],
        [
            dict(text="20",            data=f"{MENU_PREFIX}ext.create.eqqty.{eq}.20"),
            dict(text="50",            data=f"{MENU_PREFIX}ext.create.eqqty.{eq}.50"),
            dict(text="‚úçÔ∏è –í–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ", data=f"{MENU_PREFIX}ext.create.eqqty.custom.{eq}"),
        ],
        [dict(text="üîô –ù–∞–∑–∞–¥", data=f"{MENU_PREFIX}ext.create.eq")],
    ]
    await target_message.reply_text(
        txt, parse_mode=ParseMode.HTML, reply_markup=_mk_inline(kb)
    )


async def _in_add_pick_eq(q):
    txt = "üè≠ –í—ã–±–µ—Ä–∏—Ç–µ <b>–±–∞–∑—É</b>, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π —Å–æ–∑–¥–∞—Ç—å inbound-–º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –í–°–ï–• —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö EXT (–¥–∏–∞–ø–∞–∑–æ–Ω 100 –Ω–æ–º–µ—Ä–æ–≤):"
    kb = [
        [
            dict(text="1 ‚Üí 101-199",  data=f"{MENU_PREFIX}in.add.eq.1"),
            dict(text="2 ‚Üí 201-299",  data=f"{MENU_PREFIX}in.add.eq.2"),
        ],
        [
            dict(text="3 ‚Üí 301-399",  data=f"{MENU_PREFIX}in.add.eq.3"),
            dict(text="4 ‚Üí 401-499",  data=f"{MENU_PREFIX}in.add.eq.4"),
        ],
        [dict(text="10 ‚Üí 1001-1099", data=f"{MENU_PREFIX}in.add.eq.10")],
        [dict(text="‚úçÔ∏è –í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –±–∞–∑—ã", data=f"{MENU_PREFIX}in.add.eq.custom")],  # ‚Üê –ù–û–í–û–ï
        [dict(text="üîô –ù–∞–∑–∞–¥",        data=f"{MENU_PREFIX}in")],
    ]
    await _safe_edit(q, txt, parse_mode=ParseMode.HTML, reply_markup=_mk_inline(kb))



# ===== –≠–ö–†–ê–ù–´: –£–¥–∞–ª–µ–Ω–∏–µ =====

async def _ext_delete_root(q):
    txt = (
        "üóëÔ∏è <b>–£–¥–∞–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π</b>\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±:\n"
        "‚Ä¢ –£–¥–∞–ª–∏—Ç—å –ø–æ –Ω–æ–º–µ—Ä–∞–º/–¥–∏–∞–ø–∞–∑–æ–Ω—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 401 402 410-418)\n"
        "‚Ä¢ –£–¥–∞–ª–∏—Ç—å –≤—Å–µ 100 –Ω–æ–º–µ—Ä–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–∞–∑—ã (1‚Üí101‚Ä¶, 4‚Üí401‚Ä¶ –∏ —Ç.–¥.)\n"
        "‚Ä¢ –£–¥–∞–ª–∏—Ç—å –í–°–Å (–≤—Å–µ EXT)\n"
    )
    kb = [
        [dict(text="üî¢ –£–¥–∞–ª–∏—Ç—å –Ω–æ–º–µ—Ä–∞/–¥–∏–∞–ø–∞–∑–æ–Ω", data=f"{MENU_PREFIX}ext.del.numbers")],
        [dict(text="üè≠ –£–¥–∞–ª–∏—Ç—å –ø–æ –±–∞–∑–µ",         data=f"{MENU_PREFIX}ext.del.eq")],
        [dict(text="üß® –£–¥–∞–ª–∏—Ç—å –í–°–Å",             data=f"{MENU_PREFIX}ext.del_all")],
        [dict(text="üîô –ù–∞–∑–∞–¥",                   data=f"{MENU_PREFIX}ext")],
    ]
    await _safe_edit(q, txt, parse_mode=ParseMode.HTML, reply_markup=_mk_inline(kb))

async def _ext_delete_pick_eq(q):
    txt = "üè≠ –í—ã–±–µ—Ä–∏—Ç–µ <b>–±–∞–∑—É</b> –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –µ—ë –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (100 –Ω–æ–º–µ—Ä–æ–≤):"
    kb = [
        [
            dict(text="1 ‚Üí 101-199",  data=f"{MENU_PREFIX}ext.del.eq.1"),
            dict(text="2 ‚Üí 201-299",  data=f"{MENU_PREFIX}ext.del.eq.2"),
        ],
        [
            dict(text="3 ‚Üí 301-399",  data=f"{MENU_PREFIX}ext.del.eq.3"),
            dict(text="4 ‚Üí 401-499",  data=f"{MENU_PREFIX}ext.del.eq.4"),
        ],
        [dict(text="10 ‚Üí 1001-1099", data=f"{MENU_PREFIX}ext.del.eq.10")],
        [dict(text="‚úçÔ∏è –í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –±–∞–∑—ã", data=f"{MENU_PREFIX}ext.del.eq.custom")],  # ‚Üê –ù–û–í–û–ï
        [dict(text="üîô –ù–∞–∑–∞–¥",        data=f"{MENU_PREFIX}ext")],
    ]
    await _safe_edit(q, txt, parse_mode=ParseMode.HTML, reply_markup=_mk_inline(kb))



# ===== –¢–ï–ö–°–¢–û–í–´–ô –†–û–£–¢–ï–† (–≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) =====

async def menu_text_router(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ main.py –∫–∞–∫ MessageHandler(filters.TEXT & ~filters.COMMAND)."""
    if not _is_connected(context):
        return

    st = context.user_data.get("__await")
    if not st:
        return

    kind = st.get("kind")
    text = (update.message.text or "").strip()

    # —Å–æ–∑–¥–∞—Ç—å –ø–æ –±–∞–∑–µ ‚Äî –≤–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    if kind == "create_eq_qty":
        eq = int(st["eq"])
        try:
            qty = int(text)
            if qty <= 0:
                raise ValueError
        except Exception:
            await update.message.reply_text("‚ùó –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ. –ù–∞–ø—Ä–∏–º–µ—Ä: 10")
            return
        context.args = [str(eq), str(qty)]
        await create_cmd(update, context)
        context.user_data.pop("__await", None)
        return

    # –æ–¥–∏–Ω –Ω–æ–º–µ—Ä
    if kind == "add_single":
        parts = text.split(maxsplit=1)
        try:
            ext = str(int(parts[0]))
        except Exception:
            await update.message.reply_text("‚ùó –í–≤–µ–¥–∏—Ç–µ EXT, –Ω–∞–ø—Ä–∏–º–µ—Ä: 101 –∏–ª–∏ '101 –û—Ñ–∏—Å –ö–∏–µ–≤'")
            return
        name = parts[1] if len(parts) > 1 else ""
        context.args = [ext] + ([name] if name else [])
        await add_cmd(update, context)
        context.user_data.pop("__await", None)
        return

    # –¥–∏–∞–ø–∞–∑–æ–Ω
    if kind == "add_range":
        parts = text.split(maxsplit=1)
        rng = parts[0]
        name_prefix = parts[1] if len(parts) > 1 else ""
        if "-" not in rng:
            await update.message.reply_text("‚ùó –í–≤–µ–¥–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ 101-105 (–∏ –æ–ø—Ü. –ø—Ä–µ—Ñ–∏–∫—Å)")
            return
        a, b = rng.split("-", 1)
        try:
            _ = int(a); _ = int(b)
        except Exception:
            await update.message.reply_text("‚ùó –î–∏–∞–ø–∞–∑–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä 401-418")
            return
        context.args = [rng] + ([name_prefix] if name_prefix else [])
        await add_cmd(update, context)
        context.user_data.pop("__await", None)
        return

    # —É–¥–∞–ª–µ–Ω–∏–µ ‚Äî –≤–≤–æ–¥ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤/–¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
    if kind == "del_numbers":
        context.args = [text]  # –≤–µ—Å—å –≤–≤–æ–¥ –ø–æ–π–¥—ë—Ç –≤ del_cmd
        await del_cmd(update, context)
        context.user_data.pop("__await", None)
        return
    
    # Inbound: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ (EXT –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω)
    if kind == "in_add":
        # –ø—Ä–∏–Ω–∏–º–∞–µ–º "414" –∏–ª–∏ "401-418"
        text = (update.message.text or "").strip()
        if not text:
            await update.message.reply_text("‚ùó –í–≤–µ–¥–∏—Ç–µ EXT –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω, –Ω–∞–ø—Ä–∏–º–µ—Ä: 414 –∏–ª–∏ 401-418")
            return
        # –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤ add_inbound_cmd
        context.args = [text]
        await add_inbound_cmd(update, context)
        context.user_data.pop("__await", None)
        return

    # Inbound: —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ DID (EXT)
    if kind == "in_del":
        did = (update.message.text or "").strip()
        try:
            _ = int(did)
        except Exception:
            await update.message.reply_text("‚ùó DID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: 414")
            return
        context.args = [did]
        await del_inbound_cmd(update, context)
        context.user_data.pop("__await", None)
        return
    
    # –°–æ–∑–¥–∞–Ω–∏–µ EXT: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ä—É—á–Ω—É—é –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä –±–∞–∑—ã
    if kind == "create_eq_pick":
        txt = (update.message.text or "").strip()
        try:
            eq = int(txt)
            _ = equip_start(eq)
        except Exception:
            await update.message.reply_text(
                "‚ùó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –±–∞–∑—ã. –í–≤–µ–¥–∏—Ç–µ –æ–¥–Ω–æ –∏–∑: 1, 2, 3, 4, 10."
            )
            return
        await _ext_create_pick_qty_send(update.effective_message, eq)
        context.user_data.pop("__await", None)
        return

    if kind == "in_add_eq_pick":
        txt = (update.message.text or "").strip()
        try:
            eq = int(txt)
            start = equip_start(eq)
            end = start + 99
        except Exception:
            await update.message.reply_text(
                "‚ùó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –±–∞–∑—ã. –í–≤–µ–¥–∏—Ç–µ –æ–¥–Ω–æ –∏–∑: 1, 2, 3, 4, 10."
            )
            return
        context.args = [f"{start}-{end}"]
        await add_inbound_cmd(update, context)
        context.user_data.pop("__await", None)
        return
    
    if kind == "del_eq_pick":
        txt = (update.message.text or "").strip()
        try:
            eq = int(txt)
            # –≤–∞–ª–∏–¥–∏—Ä—É–µ–º, —á—Ç–æ —Ç–∞–∫–∞—è –±–∞–∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (equip_start –±—Ä–æ—Å–∏—Ç, –µ—Å–ª–∏ –Ω–µ—Ç)
            from utils.common import equip_start
            _ = equip_start(eq)
        except Exception:
            await update.message.reply_text(
                "‚ùó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –±–∞–∑—ã. –í–≤–µ–¥–∏—Ç–µ –æ–¥–Ω–æ –∏–∑: 1, 2, 3, 4, 10."
            )
            return

        from handlers.commands import del_eq_cmd  
        context.args = [str(eq)]
        await del_eq_cmd(update, context)

        context.user_data.pop("__await", None)
        return


    context.user_data.pop("__await", None)


# ===== –ì–õ–ê–í–ù–´–ô –†–û–£–¢–ï–† –ö–ù–û–ü–û–ö =====

async def menu_router(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()

    if not _is_connected(context):
        await _safe_edit(q, NOT_CONNECTED, parse_mode=ParseMode.HTML, reply_markup=back_home_kb())
        return

    data = q.data  # –Ω–∞–ø—Ä–∏–º–µ—Ä: "menu:ext.create.eqqty.4.10"
    route = data[len(MENU_PREFIX):]

    # —Ä–∞–∑–¥–µ–ª—ã
    if route == "home":
        await _safe_edit(q, "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>", parse_mode=ParseMode.HTML, reply_markup=main_menu_kb()); return
    if route == "ext":
        await _safe_edit(q, "üß© <b>Extensions</b> ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", parse_mode=ParseMode.HTML, reply_markup=ext_menu_kb()); return
    if route == "ext.create.eq.custom":
        context.user_data["__await"] = {"kind": "create_eq_pick"}
        await _safe_edit(
            q,
            "‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä <b>–±–∞–∑—ã</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1, 2, 3, 4, 10).",
            parse_mode=ParseMode.HTML,
            reply_markup=back_home_kb()
        )
        return
    if route == "ext.del.eq.custom":
        context.user_data["__await"] = {"kind": "del_eq_pick"}
        await _safe_edit(
            q,
            "‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä <b>–±–∞–∑—ã</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1, 2, 3, 4, 10).",
            parse_mode=ParseMode.HTML,
            reply_markup=back_home_kb()
        )
        return
    if route == "in":
        await _safe_edit(q, "‚¨ÖÔ∏è <b>Inbound</b> ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", parse_mode=ParseMode.HTML, reply_markup=in_menu_kb()); return
    if route == "in.list":
        await list_routes_cmd(update, context)
        return
    if route == "in.add":
        context.user_data["__await"] = {"kind": "in_add"}
        await _safe_edit(
            q,
            "‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ EXT –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è inbound route(–æ–≤).\n"
            "–ü—Ä–∏–º–µ—Ä—ã:\n"
            "<code>414</code>\n"
            "<code>401-418</code>\n"
            "–û–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –≤–∏–¥–∞ <code>sim{ext}</code>, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –Ω–∞ Extension {ext}.",
            parse_mode=ParseMode.HTML,
            reply_markup=back_home_kb()
        )
        return
    if route == "in.add.eq":
        await _in_add_pick_eq(q)
        return
    if route == "in.add.eq.custom":
        context.user_data["__await"] = {"kind": "in_add_eq_pick"}
        await _safe_edit(
            q,
            "‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä <b>–±–∞–∑—ã</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1, 2, 3, 4, 10).",
            parse_mode=ParseMode.HTML,
            reply_markup=back_home_kb()
        )
        return
    if route.startswith("in.add.eq."):
        eq = int(route.split(".")[-1])
        start = equip_start(eq)           
        end = start + 99                  
        context.args = [f"{start}-{end}"] 
        await add_inbound_cmd(update, context)
        return
    if route == "in.del":
        context.user_data["__await"] = {"kind": "in_del"}
        await _safe_edit(
            q,
            "‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ DID (EXT) –º–∞—Ä—à—Ä—É—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å.\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: <code>414</code>",
            parse_mode=ParseMode.HTML,
            reply_markup=back_home_kb()
        )
        return

    if route == "sys":
        await _safe_edit(q, "üõ† <b>System</b> ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", parse_mode=ParseMode.HTML, reply_markup=sys_menu_kb()); return
    
    if route == "sys.reconnect":
        await reconnect_cmd(update, context)
        return

    if route == "sys.ping":
        await ping_cmd(update, context)
        return

    if route == "sys.whoami":
        await whoami_cmd(update, context)
        return

    if route == "sys.logout":
        await logout_cmd(update, context)
        await _safe_edit(q, "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>", parse_mode=ParseMode.HTML, reply_markup=main_menu_kb())
        return

    if route == "gql":
        await _safe_edit(q, "üß¨ <b>GraphQL</b> ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", parse_mode=ParseMode.HTML, reply_markup=gql_menu_kb()); return
    if route == "gql.fields":
        await gql_fields_cmd(update, context)
        return
    if route == "gql.mutations":
        await gql_mutations_cmd(update, context)
        return

    if route == "help":
        await _safe_edit(q, "‚ÑπÔ∏è <b>Help</b>. –ö–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –º–µ–Ω—é.", parse_mode=ParseMode.HTML, reply_markup=back_home_kb()); return

    # —Å–ø–∏—Å–æ–∫
    if route == "ext.list":
        await list_cmd(update, context); return

    # —Å–æ–∑–¥–∞–Ω–∏–µ
    if route == "ext.create":
        await _ext_create_root(q); return
    if route == "ext.create.eq":
        await _ext_create_pick_eq(q); return
    if route.startswith("ext.create.eq."):
        eq = int(route.split(".")[-1])
        await _ext_create_pick_qty(q, eq); return
    if route.startswith("ext.create.eqqty."):
        parts = route.split(".")
        if len(parts) >= 4 and parts[3] == "custom":
            eq = int(parts[4])
            context.user_data["__await"] = {"kind": "create_eq_qty", "eq": eq}
            await _safe_edit(q,
                f"‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ <b>–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</b> –¥–ª—è –±–∞–∑—ã <b>{eq}</b> (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ):",
                parse_mode=ParseMode.HTML,
                reply_markup=back_home_kb()
            )
            return
        eq = int(parts[3]); qty = int(parts[4])
        context.args = [str(eq), str(qty)]
        await create_cmd(update, context); return
    if route == "ext.create.single":
        context.user_data["__await"] = {"kind": "add_single"}
        await _safe_edit(q,
            "‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ EXT –∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∏–º—è. –ü—Ä–∏–º–µ—Ä—ã:\n"
            "<code>101</code>\n"
            "<code>101 –û—Ñ–∏—Å –ö–∏–µ–≤</code>",
            parse_mode=ParseMode.HTML, reply_markup=back_home_kb()
        ); return
    if route == "ext.create.range":
        context.user_data["__await"] = {"kind": "add_range"}
        await _safe_edit(q,
            "‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ø—Ä–µ—Ñ–∏–∫—Å –∏–º–µ–Ω–∏. –ü—Ä–∏–º–µ—Ä—ã:\n"
            "<code>101-105</code>\n"
            "<code>401-418 –ü—Ä–æ–¥–∞–∂–∏</code>",
            parse_mode=ParseMode.HTML, reply_markup=back_home_kb()
        ); return

    # —É–¥–∞–ª–µ–Ω–∏–µ
    if route == "ext.del":
        await _ext_delete_root(q); return
    if route == "ext.del.numbers":
        context.user_data["__await"] = {"kind": "del_numbers"}
        await _safe_edit(q,
            "‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞/–¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.\n"
            "–ü—Ä–∏–º–µ—Ä—ã:\n"
            "<code>401</code>\n"
            "<code>401 402 410-418</code>",
            parse_mode=ParseMode.HTML, reply_markup=back_home_kb()
        ); return
    if route in ("ext.del.eq", "ext.del_root"):
        await _ext_delete_pick_eq(q); return
    if route.startswith("ext.del.eq."):
        eq = int(route.split(".")[-1])
        context.args = [f"{eq}"]
        from handlers.commands import del_eq_cmd  # –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç
        await del_eq_cmd(update, context); return
    if route == "ext.del_all":
        from telegram import InlineKeyboardMarkup, InlineKeyboardButton
        kb = InlineKeyboardMarkup([
            [InlineKeyboardButton("–î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å—ë", callback_data="delall:yes"),
             InlineKeyboardButton("–û—Ç–º–µ–Ω–∞",          callback_data="delall:no")]
        ])
        await _safe_edit(q, "‚ö†Ô∏è –¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –ª–∏–Ω–∏–∏?", parse_mode=ParseMode.HTML, reply_markup=kb); return

    # —Ñ–æ–ª–ª–±–µ–∫
    await _safe_edit(q,
        f"‚è≥ –ù–∞–∂–∞—Ç–æ: <code>{route}</code>. –†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.",
        parse_mode=ParseMode.HTML, reply_markup=back_home_kb()
    )

ui/keyboards.py:

from telegram import InlineKeyboardButton, InlineKeyboardMarkup

MENU_PREFIX = "menu:"  # –æ–±—â–∏–π –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

def main_menu_kb() -> InlineKeyboardMarkup:
    rows = [
        [
            InlineKeyboardButton("üß© Extensions", callback_data=f"{MENU_PREFIX}ext"),
            InlineKeyboardButton("‚¨ÖÔ∏è Inbound",    callback_data=f"{MENU_PREFIX}in"),
        ],
        [
            InlineKeyboardButton("üõ† System",     callback_data=f"{MENU_PREFIX}sys"),
            InlineKeyboardButton("üß¨ GraphQL",    callback_data=f"{MENU_PREFIX}gql"),
        ],
        [InlineKeyboardButton("‚ÑπÔ∏è Help",         callback_data=f"{MENU_PREFIX}help")],
    ]
    return InlineKeyboardMarkup(rows)

def back_home_kb() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"{MENU_PREFIX}home")]]
    )

def ext_menu_kb() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫",            callback_data=f"{MENU_PREFIX}ext.list"),
            InlineKeyboardButton("‚ú® –°–æ–∑–¥–∞—Ç—å",            callback_data=f"{MENU_PREFIX}ext.create"),
        ],
        [
            InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –Ω–æ–º–µ—Ä–∞",    callback_data=f"{MENU_PREFIX}ext.del"),
        ],
        [
            InlineKeyboardButton("üß® –£–¥–∞–ª–∏—Ç—å –í–°–Å",       callback_data=f"{MENU_PREFIX}ext.del_all"),
        ],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥",               callback_data=f"{MENU_PREFIX}home")],
    ])

def in_menu_kb() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫",         callback_data=f"{MENU_PREFIX}in.list"),
            InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å",       callback_data=f"{MENU_PREFIX}in.add"),
        ],
        [
            InlineKeyboardButton("üè≠‚ûï –î–ª—è –≤—Å–µ–π –±–∞–∑—ã", callback_data=f"{MENU_PREFIX}in.add.eq"),
            InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å",        callback_data=f"{MENU_PREFIX}in.del"),
        ],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥",            callback_data=f"{MENU_PREFIX}home")],
    ])
    
def sys_menu_kb() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üîÑ Reconnect", callback_data=f"{MENU_PREFIX}sys.reconnect"),
            InlineKeyboardButton("üèì Ping",       callback_data=f"{MENU_PREFIX}sys.ping"),
        ],
        [
            InlineKeyboardButton("üë§ WhoAmI",     callback_data=f"{MENU_PREFIX}sys.whoami"),
            InlineKeyboardButton("üö™ Logout",     callback_data=f"{MENU_PREFIX}sys.logout"),
        ],
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥",         callback_data=f"{MENU_PREFIX}home")],
    ])

def gql_menu_kb() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üìë Fields",     callback_data=f"{MENU_PREFIX}gql.fields"),
            InlineKeyboardButton("‚öí Mutations",   callback_data=f"{MENU_PREFIX}gql.mutations"),
        ],
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥",         callback_data=f"{MENU_PREFIX}home")],
    ])

ui/texts.py:

# src/ui/texts.py
from telegram import InlineKeyboardMarkup, InlineKeyboardButton

HELP_TEXT = (
    "üìò <b>–ü–æ–º–æ—â—å</b>\n\n"
    "üîå <b>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ FreePBX</b>\n"
    "  <code>/connect &lt;ip&gt; &lt;login&gt; &lt;password&gt;</code>\n"
    "  ‚Ä¢ <i>ip</i> ‚Äî –±–∞–∑–æ–≤—ã–π URL FreePBX (–Ω–∞–ø—Ä–∏–º–µ—Ä: http://77.105.146.189)\n"
    "  ‚Ä¢ <i>login</i> ‚Äî Client ID –∏–∑ FreePBX API\n"
    "  ‚Ä¢ <i>password</i> ‚Äî Client Secret –∏–∑ FreePBX API\n\n"

    "üìÑ <b>–°–ø–∏—Å–æ–∫ –ª–∏–Ω–∏–π</b>\n"
    "  <code>/list</code> ‚Äî —Å–ø–∏—Å–æ–∫ EXT –∏ –ø–∞—Ä–æ–ª–µ–π (—Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π)\n\n"

    "üÜï <b>–°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–Ω–∏–π</b>\n"
    "  <code>/create &lt;–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ&gt; &lt;–∫–æ–ª-–≤–æ&gt;</code>\n"
    "  ‚Ä¢ —Å—Ç–∞—Ä—Ç –Ω–æ–º–µ—Ä–æ–≤: 1‚Üí101, 2‚Üí201, 3‚Üí301, 4‚Üí401, 10‚Üí1001\n"
    "  ‚Ä¢ –ø—Ä–∏–º–µ—Ä: <code>/create 4 10</code> (—Å–æ–∑–¥–∞—Å—Ç 401‚Ä¶ –ø–æ –ø–æ—Ä—è–¥–∫—É)\n\n"

    "üóëÔ∏è <b>–£–¥–∞–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π</b>\n"
    "  ‚Ä¢ –¢–æ—á–µ—á–Ω–æ/–¥–∏–∞–ø–∞–∑–æ–Ω: <code>/del 401 402 410-418</code>\n"
    "  ‚Ä¢ –ü–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é:  <code>/del_eq 4</code> (–≤—Å–µ 401‚Äì499)\n"
    "  ‚Ä¢ –í—Å–µ —Å—Ä–∞–∑—É:        <code>/del_all</code>\n\n"

    "‚ôªÔ∏è <b>–°–µ—Å—Å–∏—è</b>\n"
    "  <code>/reconnect</code> ‚Äî –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏\n"
    "  <code>/ping</code> ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏ GraphQL (OK/–æ—à–∏–±–∫–∞)\n"
    "  <code>/whoami</code> ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π URL –∏ Client ID\n"
    "  <code>/logout</code> ‚Äî —Å–±—Ä–æ—Å —Å–µ—Å—Å–∏–∏\n\n"
    
    "üß© <b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π</b>\n"
    "  <code>/add &lt;ext&gt; [–∏–º—è]</code>\n"
    "  <code>/add &lt;start-end&gt; [–ø—Ä–µ—Ñ–∏–∫—Å_–∏–º–µ–Ω–∏]</code>\n"
    "  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π –ø–æ –Ω–æ–º–µ—Ä—É –∏ –∏–º–µ–Ω–∏\n\n"
    
    "üì• <b>Inbound Routes</b>\n"
    "  <code>/list_routes</code> ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤\n"
    "  <code>/add_inbound &lt;ext&gt;</code> –∏–ª–∏ <code>/add_inbound &lt;start-end&gt;</code>\n"
    "    ‚Ä¢ –°–æ–∑–¥–∞—ë—Ç –º–∞—Ä—à—Ä—É—Ç DID‚ÜíEXT, Description=simEXT\n"
    "  <code>/del_inbound &lt;ext&gt;</code>\n"
    "    ‚Ä¢ –£–¥–∞–ª—è–µ—Ç –º–∞—Ä—à—Ä—É—Ç –ø–æ DID\n\n"
)



def _list_page_text(ip: str, pairs_page):
    """–°–æ–±—Ä–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–ø–∏—Å–∫–∞ EXT/–ø–∞—Ä–æ–ª–µ–π."""
    if not pairs_page:
        return f"{ip}\n\n(–ø—É—Å—Ç–æ)"
    lines = [ip, ""]
    lines += [f"{ext} {pw}" for ext, pw in pairs_page]
    return "\n".join(lines)


def _list_nav_kb(page: int, pages: int):
    """–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º."""
    prev_btn = InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"list:page:{page-1}")
    next_btn = InlineKeyboardButton("‚û°Ô∏è", callback_data=f"list:page:{page+1}")
    nums = InlineKeyboardButton(f"{page+1}/{pages}", callback_data="noop")
    row = []
    if page > 0:
        row.append(prev_btn)
    row.append(nums)
    if page < pages - 1:
        row.append(next_btn)
    return InlineKeyboardMarkup([row]) if pages > 1 else None

MENU_WELCOME = (
    "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ.\n"
    "–í—ã–±–∏—Ä–∞–π—Ç–µ —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ ‚Äî –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤—Ä—É—á–Ω—É—é."
)

NOT_CONNECTED = (
    "‚ùóÔ∏è–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å: "
    "<code>/connect &lt;ip&gt; &lt;login&gt; &lt;password&gt;</code>"
)

utils/common.py:

import re
from typing import List, Tuple


def clean_url(url: str) -> str:
    """
    –£–±–∏—Ä–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª –∏ —Å–ª—ç—à–∏ –≤ –∫–æ–Ω—Ü–µ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
    http://1.2.3.4/  ->  1.2.3.4
    """
    return re.sub(r"^https?://", "", url).rstrip("/")


def equip_start(eq: int) -> int:
    """
    –†–∞—Å—á—ë—Ç —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ EXT –¥–ª—è –±–∞–∑—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:
      1 -> 101, 2 -> 201, 3 -> 301, 4 -> 401, 10 -> 1001
    """
    return eq * 100 + 1


def parse_targets(s: str) -> List[str]:
    """
    –†–∞–∑–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–æ–∫—É —Å –Ω–æ–º–µ—Ä–∞–º–∏/–¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ –≤ —Å–ø–∏—Å–æ–∫ EXT.
    –ü—Ä–∏–º–µ—Ä: "401 402 410-418" -> ["401","402","410","411",...,"418"]
    """
    out: List[str] = []
    for tok in s.strip().split():
        if "-" in tok:
            a, b = tok.split("-", 1)
            for n in range(int(a), int(b) + 1):
                out.append(str(n))
        else:
            out.append(tok)
    return sorted(set(out), key=lambda x: int(x))


def next_free(existing: List[str], start: int, count: int) -> List[str]:
    """
    –ù–∞—Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–µ count —Å–≤–æ–±–æ–¥–Ω—ã—Ö EXT, –Ω–∞—á–∏–Ω–∞—è —Å–æ start,
    –∏—Å–∫–ª—é—á–∞—è —Ç–µ, —á—Ç–æ —É–∂–µ –µ—Å—Ç—å –≤ existing.
    """
    taken = set(map(int, existing))
    res, cur = [], start
    while len(res) < count:
        if cur not in taken:
            res.append(str(cur))
        cur += 1
    return res


def format_list(ip: str, pairs: List[Tuple[str, str]]) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ EXT/–ø–∞—Ä–æ–ª–µ–π –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –≤–∏–¥–µ.
    """
    if not pairs:
        return f"{ip}\n\n(–ø—É—Å—Ç–æ)"
    lines = [ip, ""]
    lines += [f"{ext} {pw}" for ext, pw in pairs]
    return "\n".join(lines)

main.py:

import os
from telegram.ext import Application, Defaults, CommandHandler, CallbackQueryHandler, MessageHandler, filters
from telegram.constants import ParseMode
from dotenv import load_dotenv
from handlers.commands import list_routes_cmd
from handlers.menu import menu_router, menu_text_router  

from handlers.commands import (
    start_cmd, help_cmd, connect_cmd, list_cmd, create_cmd, del_cmd,
    del_eq_cmd, del_all_cmd, add_cmd, reconnect_cmd,
    ping_cmd, whoami_cmd, logout_cmd, on_startup, gql_fields_cmd, gql_mutations_cmd,
    menu_cmd, add_inbound_cmd, del_inbound_cmd

)
from handlers.callbacks import list_nav_cb, del_all_cb, noop_cb


def _get_token() -> str:
    load_dotenv()
    token = os.getenv("TELEGRAM_TOKEN", "").strip()
    if not token or token == "PUT_YOUR_TELEGRAM_BOT_TOKEN":
        raise RuntimeError(
            "TELEGRAM_TOKEN –Ω–µ –∑–∞–¥–∞–Ω. –£–∫–∞–∂–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_TOKEN "
            "–∏–ª–∏ –∑–∞–ø–æ–ª–Ω–∏ –µ—ë –≤ .env"
        )
    return token

def build_app():
    token = _get_token()
    defaults = Defaults(parse_mode=ParseMode.HTML)
    app = Application.builder().token(token).defaults(defaults).post_init(on_startup).build()

    app.add_handler(CommandHandler("start", start_cmd))
    app.add_handler(CommandHandler("help", help_cmd))
    app.add_handler(CommandHandler("connect", connect_cmd))
    app.add_handler(CommandHandler("list", list_cmd))
    app.add_handler(CommandHandler("create", create_cmd))
    app.add_handler(CommandHandler("del", del_cmd))
    app.add_handler(CommandHandler("del_eq", del_eq_cmd))
    app.add_handler(CommandHandler("del_all", del_all_cmd))
    app.add_handler(CommandHandler("add", add_cmd))
    app.add_handler(CommandHandler("add_inbound", add_inbound_cmd))
    app.add_handler(CommandHandler("reconnect", reconnect_cmd))
    app.add_handler(CommandHandler("ping", ping_cmd))
    app.add_handler(CommandHandler("whoami", whoami_cmd))
    app.add_handler(CommandHandler("logout", logout_cmd))
    app.add_handler(CommandHandler("del_inbound", del_inbound_cmd))
    app.add_handler(CommandHandler("list_routes", list_routes_cmd))
    app.add_handler(CommandHandler("gql_fields", gql_fields_cmd))
    app.add_handler(CommandHandler("gql_mutations", gql_mutations_cmd))
    app.add_handler(CommandHandler("menu", menu_cmd))

    app.add_handler(CallbackQueryHandler(menu_router, pattern=r"^menu:"))
    app.add_handler(CallbackQueryHandler(list_nav_cb, pattern=r"^list:page:"))
    app.add_handler(CallbackQueryHandler(del_all_cb, pattern=r"^delall:"))
    app.add_handler(CallbackQueryHandler(noop_cb, pattern=r"^noop$"))
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), menu_text_router))

    return app

if __name__ == "__main__":
    build_app().run_polling()
